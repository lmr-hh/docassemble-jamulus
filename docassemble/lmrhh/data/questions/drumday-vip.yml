metadata:
  title: Anmeldung zum Drum Day 2022
  tab title: Drum Day 2022
  short title: Drum Day
  logo:
    Drum Day 2022
  description:
    Dies ist die Anmeldung zum Drum Day 2022 für Ehrengäste.
  exit url: https://www.lmr-hh.de/project/instrument-des-jahres-drumset/
  revision_date: 2022-08-30
---
features:
  navigation: false
  hide navbar: false
  hide standard menu: true
  labels above fields: true
  javascript: [actions.js]
---
include:
  - config.yml
  - drumday-templates.yml
---
objects:
  person: Individual
  redis: DARedis
---
variable name: daten
data:
  Anmeldungen:
    Bibliothek: b!6WUxXoQj80WUPsIhFd8JKSL89XMR2F9MtpYy8ZkCvooW0mTd6lmzQIc9uJUAtP4v
    Dokument: 01W6XJMNK2N3J3U3B6KFGYRYGUX65IWEBZ
    Tabelle: "{8D9DB907-4FC4-4A4A-A843-0CCB5EAA702B}"
    Ordner: 01W6XJMNKHJHAQSSPSFFG3ICXSGA3CQI6P

  Mailgun Vorlage: drumday-anmeldung
  E-Mail Benachrichtigung: []
---
attachment:
  name: Anmeldung ${ person.name }
  filename: Anmeldung ${ person.name }
  docx template file: Anmeldung Drum Day VIP.docx
  variable name: registration
  valid formats: [pdf]
---
code: |
  def get_space_concert():
    participants = redis.hgetall("opening-concert")
    space_vip = max(50 - int(participants.get(b"vip", 0)), 0)

    return space_vip

  def get_space_clinic():
    participants = redis.hgetall("drum-clinic")
    space_regular = max(250 - int(participants.get(b"regular", 0)), 0)
    return space_regular
---
mandatory: true
question: Drum Day und Percussion Day 2022
subquestion: |
  Die Anmeldefrist für den Drum Day und Percussion Day ist abgelaufen. Es ist
  keine weitere Anmeldung mehr möglich.
buttons:
  - Beenden: exit
---
mandatory: true
under: |
  <small>
  Alle Angaben, die in diesem Formular gemacht werden, sind zur Durchführung
  der Tagung notwendig und werden ausschließlich zu dessen Durchführung
  verwendet. Daten werden nicht an Dritte weitergegeben. Beachten Sie auch
  unsere [Datenschutzhinweise](/packagestatic/docassemble.mud/datenschutzhinweise.html).
  </small>
question: Anmeldung zum Drum Day 2022
pre: |
  % if defined('workshop_error'):
  <div class="alert alert-danger">
    Ihre Auswahl für ${ workshop_error } kann leider nicht erfüllt werden.
    Bitte treffen Sie eine andere Auswahl.
  </div>
  % endif
subquestion: |
  Sehr geehrte Damen und Herren,

  hier können Sie sich für das Konzert am 16.09. mit Benny Greb, Jost Nickel und
  Beatboxer Guido anmelden. Nach erfolgreicher Anmeldung reservieren wir einen
  Sitzplatz für Sie.

  Zusätzlich können Sie sich auch am weiteren Programm, den Drum Clinics,
  teilnehmen, solange Plätze verfügbar sind.

  **Anmeldeschluss**: 15.09.2022
fields:
  - Vorname: person.name.first
  - Nachname: person.name.last
  - E-Mail: person.email
    datatype: email
  - note: |
      ### Drum Clinic

      Zum Drum Day am 16.09. werden **Benny Greb** und **Jost Nickel** in jeweils
      etwa 60 Minuten die _Drum Clinic_ durchführen. Die Veranstaltung geht von
      etwa 16:00 Uhr bis etwa 18:00 Uhr.

      [Mehr zum Instrument des Jahres und zu den Vortragenden](https://www.lmr-hh.de/drumday)

      % if get_space_clinic() <= 0:
      <div class="alert alert-danger">
        Es sind leider schon alle Plätze für die Drum Clinic ausgebucht.
      </div>
      % endif
  - Anmelden zur Drum Clinic mit Benny Greb und Jost Nickel: drum_clinic
    datatype: yesnoradio
    default: false
    show if: {code: get_space_clinic()}
    validation messages:
      required: Bitte wählen Sie eine Option aus.
  - note: |
      ### Konzert Drum Day

      Ab 19:00 Uhr findet am 16.09. ein Konzert mit Musik- und Wortbeiträgen
      statt. Es werden Benny Greb und Jost Nickel zusammen mit dem Beatboxer
      Guido zu erleben sein.

      % if get_space_concert() <= 0:
      <div class="alert alert-danger">
        Es sind leider schon alle Plätze für das Drum Day Konzert ausgebucht.
      </div>
      % endif
  - Ich möchte am Drum Day Konzert teilnehmen: opening_concert
    datatype: yesnoradio
    default: true
    show if: {code: get_space_concert()}
    validation messages:
      required: Bitte wählen Sie eine Option aus.
continue button label: Abschicken
---
need:
  - person.email
code: |
  keys = {}
  the_drum_clinic = drum_clinic if defined('drum_clinic') else False
  the_opening_concert = opening_concert if defined('opening_concert') else False
  with redis.lock("drumday-lock", timeout=5):
    if the_drum_clinic:
      if get_space_clinic() <= 0:
        define("workshop_error", "Drum Clinic")
        force_ask("drum_clinic")
      keys["drumday-drum-clinic"] = "regular"

    if the_opening_concert:
      if get_space_concert() <= 0:
        define("workshop_error", "Konzert")
        force_ask("opening_concert")
      keys["drumday-opening-concert"] = "vip"

    for hash, key in keys.items():
      redis.hincrby(hash, key, 1)
  del keys
---
need:
  - msgraph
  - mailgun
  - confirmation_email
  - registration
  - get_space_concert
code: |
  # Ensure these exist
  registration_path = registration.pdf.path()
  registration_filename = registration.pdf.filename
  data = {
    "Vorname": person.name.first,
    "Nachname": person.name.last,
    "E-Mail": person.email,
    "VIP": "Ja",
    "Drum Clinic": the_drum_clinic,
    "Konzert": the_opening_concert,
    "Anmeldedatum": current_datetime(timezone="Europe/Berlin").format_datetime('d.M.YYYY HH:mm')
  }
  msgraph.add_table_data(
    daten["Anmeldungen"]["Bibliothek"],
    daten["Anmeldungen"]["Dokument"],
    daten["Anmeldungen"]["Tabelle"],
    data
  )
  with open(registration_path, 'rb') as f:
    msgraph.upload_file(
      daten["Anmeldungen"]["Bibliothek"],
      daten["Anmeldungen"]["Ordner"],
      registration_filename,
      f
    )
  mailgun.send_email(
    to=[person],
    template=confirmation_email,
    attachments=[registration.pdf]
  )
  if get_space_concert() <= 9:
    mailgun.send_email(
      to=["paradies@lmr-hh.de"],
      template=warning_email
    )
  del registration_path, registration_filename, data, f
  Automation = True
---
template: warning_email
subject: VIP-Plätze für den Drum Day sind fast voll
content: |
  Die VIP-Plätze für den Drum Day sind fast voll. Es sind noch
  ${ get_space_concert() } Plätze verfügbar.
---
template: confirmation_email
subject: Ihre Anmeldung zum Drum Day 2022
content: |
  Vielen Dank für Ihre Anmeldung zum Drum Day 2022. Im Anhang erhalten Sie Ihre
  Anmeldebestätigung. Bringen Sie die Bestätigung bitte zum Drum Day mit.

  Für Sie wird ein Sitzplatz im reservierten Bereich vorgehalten, dieser ist im
  Saal entsprechend markiert. Bitte wenden Sie sich bei Bedarf an unser Personal
  vor Ort.

  Viele Grüße
  Das Drum Day Team
---
mandatory: true
need:
  - Automation
question: Ihre Anmeldung
subquestion: |
  Vielen Dank für Ihre Anmeldung zum Drum Day 2022.

  **Wir empfehlen Ihnen, Ihre Anmeldebestätigung hier direkt herunterzuladen**.
  Die Anmeldung wird Ihnen außerdem als Kopie per E-Mail zugeschickt.

  [Anmeldung herunterladen](${ registration.pdf.url_for() })

  Für Sie wird ein Sitzplatz im reservierten Bereich vorgehalten, dieser ist im
  Saal entsprechend markiert. Bitte wenden Sie sich bei Bedarf an unser Personal
  vor Ort.

  Wir freuen uns auf Sie.
buttons:
  - Beenden: exit
